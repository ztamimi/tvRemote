<!DOCTYPE html>
<html>
<head>
</head>

<body>
<!-- begin user interface -->
        <div>
                <div>
                        <input type="text" id="token" value="">
                        <input type="button" id="connect" value="connect">
                </div>
        </div>

	<div>
		<div>
			<div><input type="button" value="previous" id="previousMedia"></div>
			<div><input type="button" value="play" id="playPause"></div>
			<div><input type="button" value="next" id="nextMedia"></div>
		</div>
		
		<div>
			<div><input type="button" value="-" id="decreaseVol"></div>
			<div><input type="range" value="50" id="vol" min="0" max="100" step=1></div>
			<div><input type="button" value="+" id="increaseVol"></div>
		</div>

	</div>
<!-- end user interface -->

<!-- begin third-party lib -->
<script src="http://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
<!-- end third-party lib -->

<!-- begin ui script -->
<script>
	// app object
	var app = {name: "", debug: false, token: ""};

	app.init = function(n, d) {
		app.name = n;
		app.debug = d;
                if (app.debug)
                    app.token = "ABC123";
                //app.generateToken();
	};
	
        app.setTokenFunction = function(t) {
                app.token = t;
        };
	//=================================================================
	// media object
	var media = {vol: 50, play: false};

	// media init function
	media.init = function(v, p) {
		media.vol = v;
		media.play = p;
	};

	// media vol functions
	media.increaseVolFunction = function() {
		if (media.vol < 100) {
			media.vol += 1;
			ui.updateVolFunction();
			backEnd.send({"vol": media.vol});
		}
	};

	media.decreaseVolFunction = function() {
		if (media.vol > 0) {
			media.vol -= 1;
			ui.updateVolFunction();
			backEnd.send({"vol": media.vol});
		}
	};

	media.changeVolFunction = function() {
		if (app.debug)
			console.log("vol changed: " + ui.volSlider.value);

		media.vol = parseInt(ui.volSlider.value);
		backEnd.send({"vol": media.vol});
	};

	// media play/pause function
	media.playPauseFunction = function() {
		var btn = document.getElementById("playPause");
		
		media.play = !media.play;

		ui.updatePlayFunction();

		backEnd.send({"play": media.play});
	};

	//=================================================================
	// ui object
	var ui = {volSlider: null, playPauseBtn: null};

	ui.init = function() {
		ui.volSlider = document.getElementById("vol");
		ui.playPauseBtn = document.getElementById("playPause");
		ui.increaseVolBtn = document.getElementById("increaseVol");
		ui.decreaseVolBtn = document.getElementById("decreaseVol");
                
                // token
                ui.tokenInput = document.getElementById("token");
                ui.connectBtn = document.getElementById("connect");
		
		ui.registerEvents();
	};

	// register ui events
	ui.registerEvents = function() {
		ui.playPauseBtn.addEventListener("click", media.playPauseFunction, false);
		ui.increaseVolBtn.addEventListener("click", media.increaseVolFunction, false);
		ui.decreaseVolBtn.addEventListener("click", media.decreaseVolFunction, false);
		ui.volSlider.addEventListener("change", media.changeVolFunction, false);
         	ui.connectBtn.addEventListener("click", ui.setTokenFunction, false);

	};

	// ui functions
	ui.updatePlayFunction = function() {
		if (app.debug)
			console.log("ui.updatePlayFunction");
		if (media.play)
			ui.playPauseBtn.value = "pause";
		else
			ui.playPauseBtn.value = "play";
	};

	ui.updateVolFunction = function() {
		if (app.debug)
			console.log("ui.updateVolFunction");
		ui.volSlider.value = media.vol;
	};
        
        ui.setTokenFunction = function() {
                var t = ui.tokenInput.value;
                app.setTokenFunction(t);
        };

	//=================================================================
	// backEnd object
	var backEnd = {ref: null};

	backEnd.init = function(url) {
                url += 'tvRemoteApp/';
                url += app.token;
                url += '/';
                                
		backEnd.ref = new Firebase(url);
               
                backEnd.wRef = backEnd.ref.child(app.name);
		backEnd.ref = new Firebase(url);
                
                var other = "";
                if (app.name === "tv")
                        other = "remote";
                else
                        other = "tv";
                backEnd.rRef = backEnd.ref.child(other);

		// register backEnd events
		backEnd.rRef.on('child_added', backEnd.receive); 
          	backEnd.rRef.on('child_changed', backEnd.receive); 
	};

	backEnd.send = function(obj) {
		if (app.debug)
			console.log("backEnd.send: " + obj);

		backEnd.wRef.update(obj);
	};

	backEnd.receive = function(snapshot) {
		var value = snapshot.val();
                var key = snapshot.key();

		if (app.debug) {
			console.log("backEnd.receive");
                        console.log(key + ": " + value);
                }

		switch(key) {
			case 'vol':
				media.vol = parseInt(value);
				ui.updateVolFunction();
				break;
			case 'play':
				media.play = value;
				ui.updatePlayFunction();
				break;
		}
	};

	//=================================================================
	// main
	ui.init();
	media.init(100, false);	
        
        app.init('remote', true);
	backEnd.init('https://blazing-heat-3187.firebaseio.com/');

	//=================================================================
	// injection
        otherRef = backEnd.rRef;
        otherRef.update({"vol": 30});
        otherRef.update({"play": true});

	//backEnd.ref.push({from: 'inject', attr: 'play', value: true});

</script>
<!-- end ui script -->

</body>

</html>
