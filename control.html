<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">

<title>controller</title>
</head>

<body>
<!-- begin user interface -->
        <!-- ################################################ -->
        <div data-role="page" id="welcome">
                <header data-role="header">
                        <h1>Remote</h1>
                </header>
                <div data-role="content">
                    <p>To start enter the token and press connect.</p>
                    <form method="" action="">
                        <label for="token">Token</label>
                        <input type="text" id="token" value="" placeholder="Your Token...">
                        <input type="button" id="connect" value="connect">
                    </form>
                </div>
                <footer data-role="footer" data-position="fixed">
                    <nav data-role="navbar">
                        <ul>
                            <li><a data-icon="home" href="#home"></a></li>
                            <li><a data-icon="info" href="#help"></a></li>
                            <li><a data-icon="power" href="#power"></a></li>
                        </ul>
                    </nav>
                </footer>
        </div>
        
        <!-- ################################################ -->
	<div data-role="page" id="remote">
                <header data-role="header">
                        <h1>Remote</h1>
                </header>
            
		<form method="" action="" data-role="content">
                    <div data-role="fieldcontain">
			<input type="button" value="previous" id="previousMedia">
			<input type="button" value="play" id="playPause">
			<input type="button" value="next" id="nextMedia">
                    </div>
                    <!--
                    <div data-role="fieldcontain">
                        <label for="vol">volume: </label>
                        <input type="range" value="100" id="volSlider" min="0" max="100" data-highlight="true" data-mini="true" style="display: none !important">
                    </div>
                    -->
                    <div data-role="fieldcontain">
                        <label for="vol">volume: </label>
                        <input type="number" value="100" id="vol" min="0" max="100" data-mini="true" style="display: none !important">
                    </div>
		</form>

                <footer data-role="footer" data-position="fixed">
                    <nav data-role="navbar">
                        <ul>
                            <li><a data-icon="home" href="#welcome"></a></li>
                            <li><a data-icon="info" href="#help"></a></li>
                            <li><a data-icon="power" href="#power"></a></li>
                        </ul>
                    </nav>
                </footer>
	</div>
<!-- end user interface -->

<!-- begin third-party lib -->
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script src="http://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
<!-- end third-party lib -->

<!-- begin ui script -->
<script>
	//=================================================================
	// ui object
	var ui = {};
	ui.init = function() {
            ui.tokenInput = $('#token');
            ui.connectBtn = $('#connect');
            ui.volInput = $('#vol').slider();
            ui.playPauseBtn = $('#playPause');
            ui.previousMediaBtn = $('#previousMedia');
            ui.nextMediaBtn = $('#nextMedia');
                                
            ui.registerEvents();
	};
	// register ui events
	ui.registerEvents = function() {
                ui.connectBtn.on('click', ui.setTokenFunction);
                ui.playPauseBtn.on('click', ui.updatePlayByUi);
                ui.volInput.on('change', ui.updateVolumeByUi);
                ui.previousMediaBtn.on('click', ui.updateIndexByUi);
                ui.nextMediaBtn.on('click', ui.updateIndexByUi);
	};
        
	// ui functions
        ui.updatePlayByUi = function() {
            
            var playStatus = ui.playPauseBtn.val();
            
            if (playStatus === "play") {
		ui.playPauseBtn.val("pause");
                media.updatePlayByUi(true);
            }
            else {
		ui.playPauseBtn.val("play");
                media.updatePlayByUi(false);
            }
                    
            ui.playPauseBtn.button("refresh");
            
        };
        
        ui.updateVolumeByUi = function() {
            var volume = parseInt(ui.volInput.val());
            media.updateVolumeByUi(volume);
        };
        
        ui.updateIndexByUi = function(evt) {
            if (!evt)
                evt = window.event;
            var btn = evt.target;
            
            if (btn.id === "previousMedia")
                var shift = -1;
            else 
                var shift = 1;
            
            media.updateIndexByUi(shift);
        };
        
	ui.updatePlayByMedia = function(play) {
            if (play)
		ui.playPauseBtn.val("pause");
            else 
		ui.playPauseBtn.val("play");
                    
            ui.playPauseBtn.button("refresh");
        };
        
	ui.updateVolumeByMedia = function(volume) {
            ui.volInput.val(volume);
            ui.volInput.slider('refresh');
	};
        
        ui.setTokenFunction = function() {
                var t = ui.tokenInput.val();
                app.setTokenFunction(t);
                ui.slide();
        };
        
        ui.slide = function() {
                $.mobile.changePage("#remote", {transition: "slide", changeHash: false});
        };
	//=================================================================
        // app object
	var app = {name: "", debug: false, token: ""};
	app.init = function(n, d) {
		app.name = n;
		app.debug = d;
                //backEnd.init(url);
	};
	
        app.setTokenFunction = function(t) {
                app.token = t;
                backEnd.setToken();
        };
        
	//=================================================================
        //
	// media object
	var media = {};
        
	// media init function
	media.init = function(v, p, i, l) {
            media.vol = v;
            media.play = p;
            media.index = i;
            media.length = l;
	};
        
	media.updateVolumeByUi = function(volume) {
            if (app.debug)
                console.log("media.updateVolumeByUi called");
            
            if (media.vol === volume) {
                console.log("inhibit cycle");
                return;
            }
            
            media.vol = volume;
                
            backEnd.send({"vol": media.vol});
	};
        
	// media play/pause function
	media.updatePlayByUi = function(play) {	
            if (app.debug)
                console.log("media.updatePlayByUi called");
            
            if (media.play === play) {
                console.log("inhibit cycle");
                return;
            }
            
            media.play = play;

            backEnd.send({"play": media.play});
	};
        
        media.updateIndexByUi = function(shift) {
            if (app.debug)
                console.log("media.updateIndexByUi");
                
            if (media.length < 2)
                return;
            
            media.index = (media.index + shift) % media.length;
                
            backEnd.send({"index": media.index});
        };
        
        media.updateByBackend = function(key, value) {
            if (app.debug)
                console.log("media.update called");
            
            switch(key) {
		case 'vol':
                    var vol = parseInt(value);
                    if (vol !== media.vol) {
                        media.vol = vol;
                        ui.updateVolumeByMedia(media.vol);
                    }
                    break;
                                
		case 'play':
                    if (value !== media.play) {
                        media.play = value;
                        ui.updatePlayByMedia(media.play);
                    }
                    break;
                                
                case 'index':
                    if (value !== media.index) {
                        media.index = value;
                    }
                    break;
                                
                case 'length':
                    if (value !== media.length) {
                        media.length = value;
                        ui.updateLengthByMedia(media.length);
                    }
            }  
        };
        
	//=================================================================
	// backEnd object
	var backEnd = {};
        
	backEnd.init = function(url) {
            backEnd.log = null;
            backEnd.url = url;
        };
        
        backEnd.setToken = function(t) {
            var url = backEnd.url + ('tvRemoteApp/' + app.token + '/');
                                
            backEnd.ref = new Firebase(url);
               
            // register backEnd events
            backEnd.ref.on('child_added', backEnd.receive); 
            backEnd.ref.on('child_changed', backEnd.receive);
            backEnd.ref.once('child_added', ui.slide);
	};
        
	backEnd.send = function(obj) {
            if (app.debug)
		console.log("backEnd.send: " + JSON.stringify(obj));
            
            backEnd.log = obj;
            
            backEnd.ref.update(obj);
	};
        
	backEnd.receive = function(snapshot) {
            var value = snapshot.val();
            var key = snapshot.key();
            
            if (app.debug) {
		console.log("backEnd.receive");
                //console.log(key + ": " + value);
            }
            
            var obj = {};
            obj[key] = value;
            console.log("obj: " + JSON.stringify(obj));
            //console.log("log: " + JSON.stringify(backEnd.log));
            if (JSON.stringify(obj) == JSON.stringify(backEnd.log)) {
                console.log("same data, ignore");
                return;
            }
                
            media.updateByBackend(key, value);
	};
	//=================================================================
	// main
	media.init(100, false, 0, 0);	
        ui.init();
        
        app.init('remote', true);
	backEnd.init('https://blazing-heat-3187.firebaseio.com/');
	//=================================================================

</script>
<!-- end ui script -->

</body>

</html>
