<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">

<title>controller</title>
</head>

<body>
<!-- begin user interface -->
        <!-- ################################################ -->
        <div data-role="page" id="welcome">
                <header data-role="header">
                        <h1>Remote</h1>
                </header>
                <div data-role="content">
                    <p>To start enter the token and press connect.</p>
                    <form method="" action="">
                        <label for="token">Token</label>
                        <input type="text" id="token" value="" placeholder="Your Token...">
                        <input type="button" id="connect" value="connect">
                    </form>
                </div>
                <footer data-role="footer" data-position="fixed">
                    <nav data-role="navbar">
                        <ul>
                            <li><a data-icon="home" href="#home"></a></li>
                            <li><a data-icon="info" href="#help"></a></li>
                            <li><a data-icon="power" href="#power"></a></li>
                        </ul>
                    </nav>
                </footer>
        </div>
        
        <!-- ################################################ -->
	<div data-role="page" id="remote">
                <header data-role="header">
                        <h1>Remote</h1>
                </header>
            
		<form method="" action="" data-role="content">
                    <div data-role="fieldcontain">
			<input type="button" value="previous" id="previousMedia">
			<input type="button" value="play" id="playPause">
			<input type="button" value="next" id="nextMedia">
                    </div>
                    <!--
                    <div data-role="fieldcontain">
                        <label for="vol">volume: </label>
                        <input type="range" value="100" id="volSlider" min="0" max="100" data-highlight="true" data-mini="true" style="display: none !important">
                    </div>
                    -->
                    <div data-role="fieldcontain">
                        <label for="vol">volume: </label>
                        <input type="number" value="100" id="vol" min="0" max="100" data-mini="true" style="display: none !important">
                    </div>
		</form>

                <footer data-role="footer" data-position="fixed">
                    <nav data-role="navbar">
                        <ul>
                            <li><a data-icon="home" href="#welcome"></a></li>
                            <li><a data-icon="info" href="#help"></a></li>
                            <li><a data-icon="power" href="#power"></a></li>
                        </ul>
                    </nav>
                </footer>
	</div>
<!-- end user interface -->

<!-- begin third-party lib -->
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script src="http://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
<!-- end third-party lib -->

<!-- begin ui script -->
<script>
	//=================================================================
	// ui object
	var ui = {};
	ui.init = function() {
                ui.tokenInput = $('#token');
                ui.connectBtn = $('#connect');
                ui.volInput = $('#vol').slider();
                ui.playPauseBtn = $('#playPause');
                ui.previousMediaBtn = $('#previousMedia');
                ui.nextMediaBtn = $('#nextMedia');
                                
		ui.registerEvents();
	};
	// register ui events
	ui.registerEvents = function() {
                ui.connectBtn.on('click', ui.setTokenFunction);
                ui.playPauseBtn.on('click', media.playPauseFunction);
                ui.volInput.on('change', media.changeVolFunction);
                ui.previousMediaBtn.on('click', media.previousMediaFunction);
                ui.nextMediaBtn.on('click', media.nextMediaFunction);
	};
        
	// ui functions
	ui.updatePlayFunction = function() {
		if (media.play)
			ui.playPauseBtn.val("pause");
		else 
			ui.playPauseBtn.val("play");
                    
                ui.playPauseBtn.button("refresh");
        };
	ui.updateVolFunction = function() {
		ui.volInput.val(media.vol);
                ui.volInput.slider('refresh');
	};
        
        ui.setTokenFunction = function(evt) {
                var t = ui.tokenInput.val();
                app.setTokenFunction(t);
        };
        ui.slide = function() {
                $.mobile.changePage("#remote", {transition: "slide", changeHash: false});
        };
	//=================================================================
        // app object
	var app = {name: "", debug: false, token: ""};
	app.init = function(n, d) {
		app.name = n;
		app.debug = d;
                //backEnd.init(url);
	};
	
        app.setTokenFunction = function(t) {
                app.token = t;
                backEnd.setToken();
        };
	//=================================================================
	// media object
	var media = {};        
	// media init function
	media.init = function(v, p, i) {
		media.vol = v;
		media.play = p;
                media.index = i;
	};
	media.changeVolFunction = function() {
		if (app.debug)
			console.log("vol changed");
		media.vol = parseInt(ui.volInput.val());
                
		backEnd.send({"vol": media.vol});
	};
	// media play/pause function
	media.playPauseFunction = function() {	
                if (app.debug)
                        console.log("media.playPauseFunction");
		media.play = !media.play;
                
                ui.updatePlayFunction();
                
		backEnd.send({"play": media.play});
	};
        
        media.previousMediaFunction = function() {
                if (app.debug)
                        console.log("media.previousMediaFunction");
                
                media.index -= 1;
                
                backEnd.send({"index": media.index});
        };
        
        media.nextMediaFunction = function() {
                if (app.debug)
                        console.log("media.nextMediaFunction");
                
                media.index += 1;
                
                backEnd.send({"index": media.index});
        };
	//=================================================================
	// backEnd object
	var backEnd = {};
	backEnd.init = function(url) {
                backEnd.url = url;
        };
        
        backEnd.setToken = function(t) {
                var url = backEnd.url + ('tvRemoteApp/' + app.token + '/');
                                
		backEnd.ref = new Firebase(url);
               
                backEnd.rRef = backEnd.wRef = backEnd.ref;
		// register backEnd events
		backEnd.rRef.on('child_added', backEnd.receive); 
          	backEnd.rRef.on('child_changed', backEnd.receive);
                backEnd.rRef.once('child_added', ui.slide);
	};
	backEnd.send = function(obj) {
		if (app.debug)
			console.log("backEnd.send: " + obj);
		backEnd.wRef.update(obj);
	};
	backEnd.receive = function(snapshot) {
		var value = snapshot.val();
                var key = snapshot.key();
		if (app.debug) {
			console.log("backEnd.receive");
                        console.log(key + ": " + value);
                }
		switch(key) {
			case 'vol':
				var vol = parseInt(value);
                                if (vol !== media.vol) {
                                        media.vol = vol;
                                        ui.updateVolFunction();
                                }
				break;
			case 'play':
                                if (value !== media.play) {
                                        media.play = value;
                                        ui.updatePlayFunction();
                                }
				break;
                                
                        case 'index':
                                if (value !== media.index) {
                                        media.index = value;
                                }
				break;
		}
	};
	//=================================================================
	// main
	media.init(100, false, 0);	
        ui.init();
        
        app.init('remote', true);
	backEnd.init('https://blazing-heat-3187.firebaseio.com/');
	//=================================================================

</script>
<!-- end ui script -->

</body>

</html>
