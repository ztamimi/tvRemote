<!DOCTYPE html>
<html>
<head>
    <link href="//vjs.zencdn.net/4.1.0/video-js.css" rel="stylesheet">
      <script src="video.js"></script>
<!--<script type='text/javascript' src="//rawgithub.com/eXon/videojs-youtube/fffc6be504e6b791c1eef2076b97c43298753be6/src/media.youtube.js"></script>-->
<script src="media.youtube.js"></script>
</head>

<body>
<!-- begin user interface -->
        <div>
                <input type="text" id="token" value="">
        </div>

       
<video id="example_video_1" 
  class="video-js vjs-default-skin" 
  controls
  preload="auto" 
  width="640"
  height="264"
  poster="" 
  data-setup='{"techOrder":["youtube"], "src":"https://www.youtube.com/watch?v=jJ1SZ_9nM8c&list=PLny_wEI6iwNfuYtx9yEzIYxkChn2KkrXx"}'></video>
<!-- end user interface -->

<!-- begin third-party lib -->
<script src="http://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>



<!-- end third-party lib -->

<!-- begin ui script -->
<script>
	//=================================================================
	// app object
	var app = {name: "", debug: false, token: ""};

	app.init = function(n, d, url) {
		app.name = n;
		app.debug = d;
                // generate token
                app.generateToken();
                backEnd.init(url, app.token);
                media.init(-1, -1, -1);	
                ui.init();
                ui.setTokenFunction(app.token);
	};

        app.generateToken = function() {
                var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZ";//abcdefghiklmnopqrstuvwxyz";
                var string_length = 3;
                var randomstring = '';
                for (var i=0; i<string_length; i++) {
                        var rnum = Math.floor(Math.random() * chars.length);
                        randomstring += chars.substring(rnum,rnum+1);
                }
                app.token = randomstring;
                
                if (app.debug)
                    console.log(app.token);
        };
	//=================================================================
	// ui object
	var ui = {};

	ui.init = function() {             
                // token
                ui.tokenInput = document.getElementById("token");
                
                // token
                ui.setTokenFunction();
	};
        
        // token
        ui.setTokenFunction = function(t) {
                ui.tokenInput.value = t;
        };
	//=================================================================
	// media object
	var media = {};

	// media init
	media.init = function(v, p, i) {
		media.vol = v;
		media.play = p;
                media.index = i;
	};

	// media function

	media.updateVolumeFunction = function(vol) {
		if (app.debug)
			console.log("media.updateVolumeFunction");
		
		media.vol = vol;
		backEnd.send({"vol": media.vol});
	};

	media.playFunction = function() {
		if (app.debug)
			console.log("media.playFunction");
                    
		media.play = true;
		backEnd.send({"play": media.play});
	};

	media.pauseFunction = function() {
		if (app.debug)
			console.log("media.pauseFunction");
		media.play = false;
		backEnd.send({"play": media.play});
	};
        
        media.updatePlaylistIndex = function(index) {
                if (app.debug)
                        console.log("media.updatePlaylistIndex");
                
                media.index = index;
                backEnd.send({"index": media.index});
        };
	//=================================================================
	// backEnd object
	var backEnd = {ref: null};

	backEnd.init = function(url, token) {
                url += ('tvRemoteApp/' + token + '/');
                                
		backEnd.ref = new Firebase(url);
                
                backEnd.rRef = backEnd.wRef = backEnd.ref;

		// register backEnd events
         	backEnd.rRef.on('child_added', backEnd.receive); 
		backEnd.rRef.on('child_changed', backEnd.receive); 
	};

	backEnd.send = function(obj) {
		if (app.debug) {
			console.log("backEnd.send: " + obj);
                }
		backEnd.wRef.update(obj);
	};

	backEnd.receive = function(snapshot) {
		var value = snapshot.val();
                var key = snapshot.key();

		if (app.debug) {
			console.log("backEnd.receive: ");
                        console.log(key + ": " + value);
                }
                                
		switch(key) {
			case 'vol':
				var vol = value;
                                if (vol !== media.vol) {
                                        media.vol = vol;
                                        ui.updateVolFunction();
                                }
				break;
			case 'play':
                                if (value !== media.play) {
                                        media.play = value;
                                        ui.updatePlayFunction();
                                }
				break;
                        
                        case 'index':
                                if (value !== media.index) {
                                        media.index = value;
                                        ui.updatePlaylistIndexFunction();
                                }
				break;
		}
	};
      
	//=================================================================
	// main
	app.init('tv', true, 'http://blazing-heat-3187.firebaseio.com/');
        
</script>
<!-- end ui script -->
</body>

</html>
