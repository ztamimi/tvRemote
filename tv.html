<!DOCTYPE html>
<html>
<head>
</head>

<body>
<!-- begin user interface -->
        <div>
                <div>
                        <input type="text" id="token" value="">
                </div>
        </div>
	<div>
		<div>
			<video controls id="video">
			<source src="video/The Best of Molecular Gastronomy at MolecularRecipes.com.mp4" type="video/mp4">
			your browser does not support the video tag.
			</video>
		</div>
	</div>
<!-- end user interface -->

<!-- begin third-party lib -->
<script src="http://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
<!-- end third-party lib -->

<!-- begin ui script -->
<script>
	//=================================================================
	// app object
	var app = {name: "", debug: false, token: ""};

	app.init = function(n, d, url) {
		app.name = n;
		app.debug = d;
                // generate token
                app.generateToken();
                backEnd.init(url, app.token);
                media.init(10, true);	
                ui.init();
                ui.setTokenFunction(app.token);
	};

        app.generateToken = function() {
                var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZ";//abcdefghiklmnopqrstuvwxyz";
                var string_length = 3;
                var randomstring = '';
                for (var i=0; i<string_length; i++) {
                        var rnum = Math.floor(Math.random() * chars.length);
                        randomstring += chars.substring(rnum,rnum+1);
                }
                app.token = randomstring;
                
                if (app.debug)
                    console.log(app.token);
        };
	//=================================================================
	// ui object
	var ui = {};

	ui.init = function() {
		ui.videoCtrl = document.getElementById("video");
                
                // token
                ui.tokenInput = document.getElementById("token");
                
		// init media		
		//media.updateVolumeFunction();
		//media.updatePlayFunction();
                
                // token
                ui.setTokenFunction();
                
                // init vol and play
                media.updatePlayFunction();
                media.updateVolumeFunction();

		ui.registerEvents();
	};

	// register ui events
	ui.registerEvents = function() {
		ui.videoCtrl.addEventListener('volumechange', media.updateVolumeFunction, false);
		ui.videoCtrl.addEventListener('play', media.updatePlayFunction, false);
		ui.videoCtrl.addEventListener('pause', media.updatePlayFunction, false);
	};

        function testFunc() {
            console.log("volume: " + ui.videoCtrl.volume);
            console.log("is paused: " + ui.videoCtrl.paused);
        };
        
	// ui functions
	ui.updatePlayFunction = function() {
		if (app.debug)
			console.log("ui.updatePlayFunction");
		if (media.play)
			ui.videoCtrl.play();
		else
			ui.videoCtrl.pause();
	};

	ui.updateVolFunction = function() {
		if (app.debug)
			console.log("ui.updateVolFunction");
		var vol = media.vol / 100.0;
		
		if (app.debug)
			console.log(vol);

		ui.videoCtrl.volume = vol;
	};

        ui.setTokenFunction = function(t) {
                ui.tokenInput.value = t;
        };
	//=================================================================
	// media object
	var media = {};

	// media init
	media.init = function(v, p) {
		media.vol = v;
		media.play = p;
	};

	// media function
	media.updateVolumeFunction = function() {
		if (app.debug)
			console.log("media.updateVolumeFunction");
		
		var vol = parseInt(ui.videoCtrl.volume * 100);

		if (vol === media.vol)
			return;

		media.vol = vol;
		backEnd.send({"vol": media.vol});
	};

	media.updatePlayFunction = function() {
		if (app.debug)
			console.log("media.updatePlayFunction");

		var play = !ui.videoCtrl.paused;

		if (play === media.play)
			return;

		media.play = !media.play;
		backEnd.send({"play": media.play});
	};

	//=================================================================
	// backEnd object
	var backEnd = {ref: null};

	backEnd.init = function(url, token) {
                url += ('tvRemoteApp/' + token + '/');
                                
		backEnd.ref = new Firebase(url);
               
                //backEnd.wRef = backEnd.ref.child(app.name);
                
                var other = "";
                if (app.name === "tv")
                        other = "remote";
                else
                        other = "tv";
                //backEnd.rRef = backEnd.ref.child(other);
                
                
                backEnd.rRef = backEnd.wRef = backEnd.ref;

		// register backEnd events
         	backEnd.rRef.on('child_added', backEnd.receive); 
		backEnd.rRef.on('child_changed', backEnd.receive); 
	};

	backEnd.send = function(obj) {
		if (app.debug) {
			console.log("backEnd.send: " + obj);
                }
		backEnd.wRef.update(obj);
	};

	backEnd.receive = function(snapshot) {
		var value = snapshot.val();
                var key = snapshot.key();

		if (app.debug) {
			console.log("backEnd.receive: ");
                        console.log(key + ": " + value);
                }
                                
		switch(key) {
			case 'vol':
				var vol = parseInt(value);
                                if (vol !== media.vol) {
                                        media.vol = vol;
                                        ui.updateVolFunction();
                                }
				break;
			case 'play':
                                if (value !== media.play) {
                                        media.play = value;
                                        ui.updatePlayFunction();
                                }
				break;
		}
	};
      
	//=================================================================
	// main
	app.init('tv', true, 'http://blazing-heat-3187.firebaseio.com/');
        
        // inject
        //var otherRef = backEnd.rRef;
        //otherRef.update({"vol": 10});
        //otherRef.update({"play": true});


        //otherRef.update({"test": 5});

        // end inject

</script>
<!-- end ui script -->
</body>

</html>
