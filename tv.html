<!DOCTYPE html>
<html>
<head>
</head>

<body>
<!-- begin user interface -->
        <div>
		<div><input type="text" value="ztamimi@kent.edu" id="token"></div>
		<div><input type="button" value="signUp" id="signUp"></div>
                <div><input type="button" value="signIn" id="signIn"></div>
	</div>
	<div>
		<div>
			<video controls id="video">
			<source src="video/The Best of Molecular Gastronomy at MolecularRecipes.com.mp4" type="video/mp4">
			your browser does not support the video tag.
			</video>
		</div>
	</div>
<!-- end user interface -->

<!-- begin third-party lib -->
<script src="http://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
<!-- end third-party lib -->

<!-- begin ui script -->
<script>
	//=================================================================
	// app object
	var app = {name: "", debug: false};

	app.init = function(n, d) {
		app.name = n;
		app.debug = d;
	};

	//=================================================================
	// ui object
	var ui = {};

	ui.init = function() {
                // main
		ui.videoCtrl = document.getElementById("video");

                // connect
		ui.tokenInput = document.getElementById("token");
		ui.signUpBtn = document.getElementById("signUp");
		ui.signInBtn = document.getElementById("signIn");

                // init media		
		media.updateVolumeFunction();
		media.updatePlayFunction();

		ui.registerEvents();
	};

	// register ui events
	ui.registerEvents = function() {
		ui.videoCtrl.addEventListener('volumechange', media.updateVolumeFunction, false);
		ui.videoCtrl.addEventListener('play', media.updatePlayFunction, false);
		ui.videoCtrl.addEventListener('pause', media.updatePlayFunction, false);

                // connect
		ui.signUpBtn.addEventListener("click", ui.signUpFunction, false);
                ui.signInBtn.addEventListener("click", ui.signInFunction, false);                

	};

	// ui functions
	ui.updatePlayFunction = function() {
		if (app.debug)
			console.log("ui.updatePlayFunction");
		if (media.play)
			ui.videoCtrl.play();
		else
			ui.videoCtrl.pause();
	};

	ui.updateVolFunction = function() {
		if (app.debug)
			console.log("ui.updateVolFunction");
		var vol = media.vol / 100.0;
		
		if (app.debug)
			console.log(vol);

		ui.videoCtrl.volume = vol;
	};

	ui.signUpFunction = function() {
		var token = ui.tokenInput.value;
		backEnd.signUp(token);
	};
        
        ui.signInFunction = function() {
		var token = ui.tokenInput.value;
		backEnd.signIn(token);
	};

	//=================================================================
	// media object
	var media = {vol: 50, play: false};

	// media init
	media.init = function(v, p) {
		media.vol = v;
		media.play = p;
	};

	// media function
	media.updateVolumeFunction = function() {
		if (app.debug)
			console.log("media.updatePlayFunction");
		if (app.debug)
			console.log("videoCtrl.volume: " + ui.videoCtrl.volume);
		
		var vol = parseInt(ui.videoCtrl.volume * 100);

		if (app.debug)
			console.log("vol: " + vol);

		if (vol === media.vol)
			return;

		media.vol = vol;
		backEnd.send("vol", vol);
	};

	media.updatePlayFunction = function() {
		if (app.debug)
			console.log("media.updatePlayFunction");

		var play = !ui.videoCtrl.paused;

		if (app.debug)
			console.log("play: " + play);

		if (play === media.play)
			return;

		media.play = !media.play;
		backEnd.send("play", media.play);
	};

	//=================================================================
	// backEnd object
	var backEnd = {ref: null};
        
        backEnd.user = {email: "", password: ""};

	backEnd.init = function(url) {
		backEnd.ref = new Firebase(url);

		// register backEnd events
		backEnd.ref.limitToLast(1).on('child_added', backEnd.receive);
	};

	backEnd.send = function(a, v) {
		if (app.debug)
			console.log("backEnd.send");

		backEnd.ref.push({from: app.name, attr: a, value: v});
	};

	backEnd.receive = function(snapshot) {
		var data = snapshot.val();
		if (data.from === app.name)
			return;

		if (app.debug)
			console.log("backEnd.receive");
		console.log(data.attr + ": " + data.value);
		switch(data.attr) {
			case 'vol':
				media.vol = parseInt(data.value);
				ui.updateVolFunction();
				break;
			case 'play':
				media.play = data.value;
				ui.updatePlayFunction();
				break;
		}
	};
	
        backEnd.signUp = function(token) {
                if (app.debug)
                    console.log("sign up");
                
                backEnd.user.email = token;
                backEnd.user.password = token;
                
                backEnd.ref.createUser(backEnd.user, backEnd.signUpCallback);
        };
        
        backEnd.signIn = function(token) {
                if (app.debug)
                    console.log("sign in");
                
                backEnd.user.email = token;
                backEnd.user.password = token;
                
                backEnd.auth();
        };
        
	backEnd.auth = function() {
                if (app.debug)
                    console.log("auth");
                
                backEnd.ref.authWithPassword(backEnd.user, backEnd.authCallback);
	};
        
        backEnd.signUpCallback = function(error) {
                if (error === null) {
                        console.log("User created successfully");
                        backEnd.auth();
                }
                else
                    console.log("Error creating user:", error);
        };
        
	backEnd.authCallback = function(error, authData) {

		if (app.debug)
			console.log("authCallback");

		if (error) {
			console.log("Failed to login " + error);
			return;
		}
		
		console.log("authData " + authData);
	}
	//=================================================================
	// main
	app.init('tv', true);
	backEnd.init('https://blazing-heat-3187.firebaseio.com/');
	media.init(50, false);	
	ui.init();

</script>
<!-- end ui script -->
</body>

</html>
